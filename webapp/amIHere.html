<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Scaventure - the Adventure Awaits</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="assets/scaventure.min.css" />
    <link rel="stylesheet" href="assets/jquery.mobile.icons.min.css" />
    <link rel="stylesheet" href="assets/jquery.mobile.structure-1.4.2.min.css" />
    <script src="assets/jquery-1.11.1.js"></script>
    <script src="assets/jquery.mobile-1.4.2.js"></script>

    <!---->
    <script src="http://maps.google.com/maps/api/js?sensor=false&libraries=geometry"></script>
    <script type="text/javascript" src="assets/gmap3.js"></script>

    <style type="text/css">
        #map_canvas {
            background-color:#005599;
            margin:0 auto;
            width:90%;
            height:450px;
        }
    </style>
</head>
<body>

<div data-role="page">
    <div data-role="header">
        <h1>Scaventure</h1>
    </div><!-- /header -->

    <div data-role="main" class="ui-content">
        <div id="map_canvas"></div>

        <button class="ui-btn" id="btnAreWeThereYet">Are We There Yet?</button>


        <div id="location">
            <table id="status">
                <tr>
                    <td colspan="2"></td>
                </tr>
                <tr>
                    <td>Latitude:</td>
                    <td class="numDistance"><div id="myPosLat"></div></td>
                </tr>
                <tr>
                    <td>Longitude:</td>
                    <td class="numDistance"><div id="myPosLng"></div></td>
                </tr>
            </table>
        </div>
        <div id="distance">
            <table id="cityDistance">
                <tr>
                    <td>Distance From:</td>
                    <td><div id="divDistanceFrom"></div></td>
                </tr>


            </table>
        </div>

        <p>
            GPS status: <span id="geoStatus"></span><br/>
            Lat: <span id="lat"></span><br/>
            Lng: <span id="lng"></span><br/>
        </p>

        <div data-role="popup" id="transitionExample" class="ui-content" data-theme="d">
            <p>I'm a simple popup.</p>
        </div>

    </div><!-- /content -->
</div><!-- /page -->

<div data-role="dialog" id="dialogFoundIt">
    <div data-role="header">
        <h1>Woot!</h1>
    </div>
    <div data-role="content">
        <h1>You've found it!</h1>
        <a href="#" data-role="button" data-rel="back" data-theme="b">Continue</a>
    </div>
</div><!-- /dialog -->

<script type="text/javascript">

    var myLat; // stores user's latitude
    var myLng; // stores user's longitude

    // sets everything up on page load
    $(window).load(function (){
        loadMap();
        setLocation();

        $("#btnAreWeThereYet").click( function() {
            if (myLat && myLng) {
                getDistanceToClue();
            }
        });
    });

    function getClientPosition(position) {
        return new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
    }

    function loadMap(){


        /*
        $('#map_canvas').gmap('getCurrentPosition', function(position, status) {
            console.log("getCurrentPosition");
            if ( status === 'OK' ) {
                console.log("getCurrentPosition OK");
                var clientPosition = getClientPosition(position);


                $('#map_canvas').gmap(
                        'addShape',
                        'Circle', {
                            'strokeColor': "#FF0000", 'strokeOpacity': 0.8, 'strokeWeight': 2, 'fillColor': "#FF0000",
                            'fillOpacity': 0.35, 'center': clientPosition, 'radius': 6
                        }
                );

            }
        });*/
    }

    // calculate distance to clue
    function getDistanceToClue() {
        console.log("getDistanceToClue");
        var selectedCity = "Atlanta";
        var selectedHuntIndex = 0;
        var nextClueIndex = 1;
        $.getJSON("assets/scaventureJSON.json", function(result) {
            var lat = 0;
            var lng = 0;

            $.each(result.scaventure.cities, function() { // loop through each city
                if (this.name === selectedCity) { // if selected city equals current city
                    //console.log("Found! City Name - " + this.name);
                    $.each(this.hunt, function(index) { // loop through city's hunts
                        //console.log("City Index " + index);
                        if (index === selectedHuntIndex) { // if selected hunt equals selected Hunt
                            //console.log("Found! Hunt Name - " + this.name);
                            $.each(this.clues, function(index) { // loop through hunt's clues
                                //console.log("Clue Index " + index);
                                if (index === nextClueIndex) { // if selected clue equals selected clue
                                    //console.log("Clue Name - " + this.name);
                                    lat = parseFloat(this.location.latitude); //get current latitude
                                    lng = parseFloat(this.location.longitude); // get current longitude
                                    //console.log("Clue location - " + lat + ", " + lng);
                                    var clueLatLng = new google.maps.LatLng(lat, lng);
                                    var distanceFrom = calculateDistanceNextClue(clueLatLng);
                                    //console.log("Clue Distance From - " + distanceFrom);
                                    areWeThereYet(distanceFrom);
                                }
                            });
                        }
                    });
                }
            });
        });
    }

    // calculates distance to next clue
    function calculateDistanceNextClue(clueLatLng) {
        // set up variables and objects for distance
        var conEarth = 3963.19; // ave. miles circumference
        var gmapsSpherLib = google.maps.geometry.spherical;

        var myLatLng = new google.maps.LatLng(myLat, myLng);
        var distTo = gmapsSpherLib.computeDistanceBetween(myLatLng,clueLatLng,conEarth).toFixed(2);
        console.log("Distance To - " + distTo);
        $("#divDistanceFrom").html(distTo + " mi.");
        return distTo;
    }

    // checks if current location is close enough to the
    function areWeThereYet(distanceFrom) {
        console.log("areWeThereYet(" + distanceFrom + ")");
        var areWe = distanceFrom < 0.25;
        console.log("areWeThereYet? " + areWe);

        $.mobile.changePage("#dialogFoundIt", { transition: 'pop', changeHash: true, role: 'dialog' });
    }

    function geoSuccess(position) {
        console.log("geoSuccess");
        // get our lat and lng coordinates
        myLat = position.coords.latitude;
        myLng = position.coords.longitude;
        // display the coords and timestamp object fields
        $("#lat").html(myPosLat);
        $("#lng").html(myPosLng);

        // reverse geocode the lat and lng

        // setup map using gmap3 plugin
        $("#map_canvas").gmap3({
            map: {
                options: {
                    center: [myLat, myLng],
                    zoom:15
                },
                mapTypeId: google.maps.MapTypeId.SATELLITE,
                mapTypeControl: true,
                mapTypeControlOptions: {
                    style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
                },
                navigationControl: true,
                scrollwheel: true,
                streetViewControl: true
            },
            marker: {
                values: [
                    {latLng:[myLat, myLng], data:"You are here.", options:{icon: "http://maps.google.com/mapfiles/marker.png"}}
                ]
            }
        });
    }

    // error handler for getCurrentPosition
    function geoErrorHandler(error) {
        // initialize our error message
        var errMessage = 'ERROR: ';
        // based on the error code parameter set the message
        switch(error.code) {
            case error.PERMISSION_DENIED:
                errMessage += 'User did not share geolocation data.';
                break;
            case error.POSITION_UNAVAILABLE:
                errMessage += 'Could not detect current position.';
                break;
            case error.TIMEOUT:
                errMessage += 'Retrieving position timed out.';
                break;
            default:
                errMessage += 'Unknown error.';
                break;
        }
        // display the error to the user
        $("#geoStatus").html(errMessage);
    }

    function setLocation(){
        console.log("setLocation");
        // check for geolocation support
        if (navigator.geolocation) {
            // oldest allowed is 1 minute and timeout as 30 sec.
            var posOptions = {maximumAge:60000, timeout:30000};
            // make asynchronous getCurrentPosition call
            navigator.geolocation.getCurrentPosition(geoSuccess, geoErrorHandler, posOptions);

            $("#geoStatus").html("Retrieving your location.");
        } else {
            $("#geoStatus").html("Geolocation API Not Supported");
        }

    }

</script>

</body>
</html>
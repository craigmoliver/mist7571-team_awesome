<!DOCTYPE html>
<html>
<head>
	<title>My Page</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="assets/scaventure.min.css" />
    <link rel="stylesheet" href="assets/jquery.mobile.icons.min.css" />
    <link rel="stylesheet" href="assets/jquery.mobile.structure-1.4.2.min.css" />
    <script src="assets/jquery-1.11.1.js"></script>
    <script src="assets/jquery.mobile-1.4.2.js"></script>

    <!---->
    <script src="http://maps.google.com/maps/api/js?sensor=false&libraries=geometry"></script>
    <script type="text/javascript" src="assets/jquery.ui.map.js"></script>
    <script type="text/javascript" src="assets/jquery.ui.map.extensions.js"></script>
    <script type="text/javascript" src="assets/jquery.ui.map.overlays.js"></script>

    <style type="text/css">
        #map_canvas {
            background-color:#005599;
            margin:0 auto;
            width:90%;
            height:450px;
        }
    </style>

    <script type="text/javascript">

        $(window).load(function (){

            loadMap();
            setLocation();
        });

        function getClientPosition(position) {
            return new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
        }

        function loadMap(){
            $('#map_canvas').gmap('getCurrentPosition', function(position, status) {
                console.log("getCurrentPosition");
                if ( status === 'OK' ) {
                    console.log("getCurrentPosition OK");
                    var clientPosition = getClientPosition(position);
                    $('#map_canvas').gmap('addMarker', {
                        'position': clientPosition,
                        'bounds': true
                    });
                    /*$('#map_canvas').gmap(
                     'addShape',
                     'Circle', {
                     'strokeWeight': 0,
                     'fillColor': "#008595",
                     'fillOpacity': 0.25,
                     'center': clientPosition,
                     'radius': 15,
                     'clickable': false}
                     );*/
                    $('#map_canvas').gmap(
                            'addShape',
                            'Circle',
                            {
                                'strokeColor': "#FF0000",
                                'strokeOpacity': 0.8,
                                'strokeWeight': 2,
                                'fillColor': "#FF0000",
                                'fillOpacity': 0.35,
                                'center': clientPosition,
                                'radius': 6
                            }
                    );
                }
            });
        }



        function reverseGeoCode(geoLatLng) {
            // create our object instances
            var geocoder = new google.maps.Geocoder();
            var infowindow = new google.maps.InfoWindow();
            // perform our geocoding
            geocoder.geocode({'latLng': geoLatLng}, function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    var map = $("#map_canvas").gmap('get', 'map');
                    // check if we received an address
                    if (results[0]) {
                        // create marker on map
                        var marker = new google.maps.Marker({
                            position: geoLatLng,
                            map: map
                        });
                        // set the content to the address and open the window
                        infowindow.setContent(results[0].formatted_address);
                        infowindow.open(map, marker);
                    }
                } else {
                    alert('Geocoder failed due to: ' + status);
                }
            });
        }

        // calculate distance function
        function calculateDistance(disLatLng) {
            // set up variables and objects for distance
            var conEarth = 3963.19; // ave. miles circumference
            var gmapsSpherLib = google.maps.geometry.spherical;
            // points of interest
            var NYCLatLng = new google.maps.LatLng(40.7141667,-74.0063889);
            var LDNLatLng = new google.maps.LatLng(51.5001524,-0.1262362);
            var SFOLatLng = new google.maps.LatLng(37.615223,-122.389979);
            // distance calculations
            var distFromLDN = gmapsSpherLib.computeDistanceBetween(disLatLng,LDNLatLng,conEarth).toFixed(2);
            var distFromNYC = gmapsSpherLib.computeDistanceBetween(disLatLng,NYCLatLng,conEarth).toFixed(2);
            var distFromSFO = gmapsSpherLib.computeDistanceBetween(disLatLng,SFOLatLng,conEarth).toFixed(2);
            // set display with values
            document.getElementById('divDistFromLDN').innerHTML = distFromLDN + ' mi.';
            document.getElementById('divDistFromNYC').innerHTML = distFromNYC + ' mi.';
            document.getElementById('divDistFromSFO').innerHTML = distFromSFO + ' mi.';
        }

        function geoSuccess(position) {

            // get our lat and lng coordinates
            var myPosLat = position.coords.latitude;
            var myPosLng = position.coords.longitude;
            // display the coords and timestamp object fields
            document.getElementById('myPosLat').innerHTML = myPosLat;
            document.getElementById('myPosLng').innerHTML = myPosLng;
            // create our latlng object
            var myLatLng = new google.maps.LatLng(myPosLat, myPosLng);
            // set our options for the map and create the map


            // reverse geocode the lat and lng
            reverseGeoCode(myLatLng);
            // calculate the distance to points of interest
            calculateDistance(myLatLng);
            // update our status
            document.getElementById('geoStatus').innerHTML = 'Location Retrieved';
        }

        // error handler for getCurrentPosition
        function geoErrorHandler(error) {
            // initialize our error message
            var errMessage = 'ERROR: ';
            // based on the error code parameter set the message
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errMessage += 'User did not share geolocation data.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errMessage += 'Could not detect current position.';
                    break;
                case error.TIMEOUT:
                    errMessage += 'Retrieving position timed out.';
                    break;
                default:
                    errMessage += 'Unknown error.';
                    break;
            }
            // display the error to the user
            document.getElementById('geoStatus').innerHTML = errMessage;
        }

        function setLocation(){
            var divStatus = document.getElementById('geoStatus');

            // check for geolocation support
            if (navigator.geolocation) {
                // oldest allowed is 1 minute and timeout as 30 sec.
                var posOptions = {maximumAge:60000, timeout:30000};
                // make asynchronous getCurrentPosition call
                navigator.geolocation.getCurrentPosition(geoSuccess, geoErrorHandler,posOptions);
                divStatus.innerHTML = 'Retrieving your location.';
            } else {
                divStatus.innerHTML = 'Geolocation API Not Supported';
            }
        }

    </script>

</head>
<body>

<div data-role="page">
    <div data-role="header">
        <h1>Scaventure</h1>
    </div><!-- /header -->

    <div data-role="main" class="ui-content">
        <div id="map_canvas"></div>
        <div id="location">
            <table id="status">
                <tr>
                    <td colspan="2"><div id="geoStatus"></div></td>
                </tr>
                <tr>
                    <td>Latitude:</td>
                    <td class="numDistance"><div id="myPosLat"></div></td>
                </tr>
                <tr>
                    <td>Longitude:</td>
                    <td class="numDistance"><div id="myPosLng"></div></td>
                </tr>
            </table>
        </div>
        <div id="distance">
            <table id="cityDistance">
                <tr>
                    <td>London:</td>
                    <td class="numDistance"><div id="divDistFromLDN"></div></td>
                </tr>
                <tr>
                    <td>New York:</td>
                    <td class="numDistance"><div id="divDistFromNYC"></div></td>
                </tr>
                <tr>
                    <td>San Francisco:</td>
                    <td class="numDistance"><div id="divDistFromSFO"></div></td>
                </tr>
            </table>
        </div>
    </div><!-- /content -->
</div><!-- /page -->

<script type="text/javascript">

</script>


</body>
</html>
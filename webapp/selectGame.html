<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Scaventure - the Adventure Awaits</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="assets/scaventure.min.css" />
    <link rel="stylesheet" href="assets/jquery.mobile.icons.min.css" />
    <link rel="stylesheet" href="assets/jquery.mobile.structure-1.4.2.min.css" />
    <script src="assets/jquery-1.11.1.min.js"></script>
    <script src="assets/jquery.mobile-1.4.2.min.js"></script>

    <!--Google Fonts-->
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Seaweed+Script">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Abel">

    <script>
    // function to read storage and init form
    function checkStorage() {
        // check if local storage available
        if (window.localStorage) {
            var key, value, field;
            // loop through local storage
            for (var i = 0; i < localStorage.length; i++) {
                // retrieve the key
                key = localStorage.key(i);
                
                // set the field from the key
                field = document.getElementById(key);
                
                // check for field and assign value
                if (field) {
                    // retrieve the value
                    value = unescape(localStorage.getItem(key));
                    // set the field value
                    field.value = value; 
                }
            } // end for loop
        } // end local storage check 
    } // end function
    
    // set the localStorage with the changed field
    function updateStorage(elKey, elValue) {
        // check if local storage is available
        if (window.localStorage) {
            var key, value;
            
            // set key to form field id
            key = elKey;
            
            // set value to form field value
            value = elValue;
            
            // try to set item in local storage 
            try {
                localStorage.setItem(key, value);
                var savedVal = localStorage.getItem(key);
                console.log("Saved [" + key + "] into localStorage with the Value => " + savedVal);
            }
            catch (err) {
                //unable to set item in local storage
                if (err.code == QUOTA_EXCEEDED_ERR) {
                    alert('localStorage ran out of memory.'); }
                }
            } else {
                alert('localStorage is not supported.');
            } 
        }
    // initialize our form from local storage
    window.addEventListener('load',checkStorage,false);
    </script>
    
	<script>
 	$(document).ready(function(){
        var json;

    	//load the json object into the local storage and initialize cities
	    $.getJSON("assets/scaventureJSON.json", function(result) {
            result = JSON.stringify(result);
            updateStorage('json', result);
	    

            //retrieve json data from local storage
            json = JSON.parse(localStorage.getItem('json'));


            //populate city select with cities
            $.each(json.scaventure.cities, function(key, value) {
                console.log("Scaventure City [" + key + "] => " + value.name);
                $("#cityList").append($("<option></option>").attr("value",key).text(value.name));

                //trigger change to re-initialize select options when loop hits the last city in array
                if (key == json.scaventure.cities.length-1){
                    $("#cityList").trigger("change");
                }
            });
        });

        //dynamically populate hunt select based on city selection
        $("#cityList").bind("change", function(){
            //get city selected
            var cityID = $("#cityList").prop("selectedIndex");
            var city = $("#cityList option:selected").text();
            console.log("City Selected ID => " + cityID + " Value => " + city);

            //update local storage with city
            updateStorage('cityID', cityID);
            updateStorage('city', city);

            //empty hunt select options
            $("#huntList").empty();

            //populate hunt select with hunts based on city selection
            $.each(json.scaventure.cities, function(key, value) {
                if (value.name == city){
                   $.each(json.scaventure.cities[key].hunt, function(key, value) {
                        console.log(city + " Scaventure Hunt [" + key + "] => " + value.name);
                        $("#huntList").append($("<option></option>").attr("value",key).text(value.name));

                        //trigger change to re-initialize select options when loop hits the last hunt in array
                        if (key == json.scaventure.cities[key].hunt.length-1){
                            $("#huntList").trigger("change");
                        }
                        
                    });          
                } 
            });
        });

        $("#huntList").bind("change", function(){
            //get hunt selected
            var huntID = $("#huntList").prop("selectedIndex");
            var hunt = $("#huntList option:selected").text();
            console.log("Hunt Selected ID => " + huntID + " Value => " + hunt);

            //update local storage with city
            updateStorage('huntID', huntID);
            updateStorage('hunt', hunt);
        });
	});
	</script>
</head>
<body>
	<div data-role="page"><!-- page -->
    <!-- header -->
    <div data-role="header">
        <a href="index.html" data-icon="home">Home</a>
        <h1>Scaventure</h1>
    </div>
    <br/>
    <!-- logo-->
    <div data-role="main" class="ui-content">
        <img src="assets/images/mustache.png" width="70" height="70" style="float: right; display: block;"></img>
    </div>

    <!-- content -->
    <div data-role="content" data-inset="true">
    	<div data-role="fieldcontain">
			<label for="cityList" class="select">Select a City:</label>
			<select name="select-choice-1" id="cityList" data-native-menu="false"></select>
		</div>
    </div>
    <div data-role="content" data-inset="true">
        <div data-role="fieldcontain">
            <label for="huntList" class="select">Select a Hunt:</label>
            <select name="select-choice-1" id="huntList" data-native-menu="false"></select>
        </div>
    </div>
    <a href="theHunt.html" data-role="button">Start Game</a> 
    <!-- /content -->

    <!-- /footer -->
    <div data-role="footer">
        <h4>2014 Scaventure - MIST 7571 | Team Awesome</h4>
    </div>

</div><!-- /page -->
</body>
</html>